# 操作系统—编译链接

<figure><img src="../.gitbook/assets/image (4) (1).png" alt=""><figcaption><p>程序编译、链接、装载与运行</p></figcaption></figure>

## 一、编译

编译就是把文本形式源代码翻译为机器语言形式的目标文件的过程。分为两个阶段：编译和汇编

### 1.1 编译

编译是读取源程序(字符流)，做词法和语法的分析，将高级语言指令转换为功能等效汇编代码。

编译过程主要包括：

* **预处理阶段**

> 预处理阶段将根据已放置在文件中的预处理指令来修改源文件的内容。主要以下几方面：
>
> * 宏定义指令：`#define`
> * 条件编译指令：如`#ifdef`、`#ifndef`、`#else`、`#elif`、`#endif`等。
> * 头文件包含指令：`#include`
> * 特俗符号，预处理程序可识别的一些特殊符号：如LINE标识、FILE标识

* **编译优化阶段**

> 经过预编译得到的输出文件中，只有常量，以及C语言的关键字。
>
>
>
> 编译程序所做的工作就是通过词法分析和语法分析，在确认所有的指令都符合语法规则后，将其翻译成等价的中间代码或汇编代码。
>
>
>
> 优化处理分为两部分
>
> * 中间代码优化：删除公共表达式、循环优化、复写传播，以及无用赋值的删除等
> * 目标代码的优化：与硬件结构密切相关

### 1.2 汇编

汇编实际上指把汇编语言代码翻译成目标机器指令的过程。目标文件中所存放的也就是与源程序等效的目标的机器语言代码。目标文件由段组成。通常一个目标文件中至少有两个段：

* **代码段：**包含的主要是程序的指令，一般是可读和可执行的，不可写
* **数据段：**主要存放程序中要用到各种全局变量或静态的数据。一般是可读、可写、可执行的

UNIX下主要有三种类型的目标文件：

* **可重定位文件**：包含有适合于其他目标文件链接来创建一个可执行的或者共享的目标文件的代码或数据
* **共享的目标文件**：存放适合于在两种上下文里链接的代码和数据。
  * 链接程序可把它与其它可重定位文件及共享的目标文件一起处理来创建另一个 目标文件；
  * 动态链接程序将它与另一个可执行文件及其它的共享目标文件结合到一起，创建一个进程映象。
* **可执行文件**：包含一个可以被操作系统创建一个进程来执行的文件。汇编生成的实际是第一种类型的目标文件。



## 二、链接

链接是把相关目标文件进行组织，即将在一个文件中引用的符号同该符号在另外一个文件中的定义连接起来，使得所有的目标文件形成可执行代码的过程。

链接处理可分为两种：

* **静态链接**

> 函数的代码将从其所在地静态链接库中被拷贝到最终的可执行程序中，该程序在被执行时这些代码将被装入到该进程的虚拟地址空间中。
>
> 静态链接库实际是一个目标文件的集合，每个文件含有库中的一个或一组相关函数的代码。

* **动态链接**

> 函数的代码被放到称作是动态链接库或共享对象的某个目标文件中。链接程序此时所作的只是在最终的可执行程序中记录下共享对象的名字以及其它少量的登记信息。在此可执行文件被执行时，动态链接库的全部内容将被映射到运行时相应进程的虚地址空间。动态链接程序将根据可执行程序中记录的信息找到相应的函数代码。

## 三、运行

操作系统 jmp 到进程的第一条指令并不是 main 方法，而是别的代码。这些代码负责初始化 main 方法执行所需要的环境并调用 main 方法执行，运行这些代码的函数被称为入口函数或者入口点（Entry Point）

一个程序的执行过程如下：

1. 操作系统在创建进程后，jmp到这个进程的入口函数
2. 入口函数对程序运行环境进行初始化，包括堆、I/O、线程、全局变量的构造等。
3. 入口函数在完成初始化后，调用main函数，开始执行程序的主体
4. main函数执行完毕后返回到入口函数，入口函数进行清理工作，最后通过系统调用结束进程

栈为每一个函数调用维护了其所需要的一些信息，为每个函数所维护的信息部分叫做栈帧（Stack Frame），栈被分割为很多个栈帧。每一个栈帧保存了一个函数的如下信息：

* 函数的参数和返回地址
* 临时变量，包括非静态局部变量和编译生成的其他临时变量
* 保存的上下文

一个函数被调用时将会有如下操作：

1. 把所有的参数压入栈中，有些参数也可以不压栈而通过寄存器进行传递
2. 把当前指令的下一条指令的地址压入栈中
3. 跳转到函数体执行



## 常见面试题

#### 1、什么是符号表

符号：目标文件中的某些部分是需要在链接的时候被使用到的 “粘合剂”，此部分称为”符号“。每一个变量和函数都有自己的符号，符号保存在符号表中。

符号表中主要保存了定义在本目标文件中可以被其他目标文件引用的符号和本目标文件中引用的全局符号，这两个符号呈现互补关系。

```
// 数组坐标       符号值        size   符号类型     绑定信息       符号名称
    8:    0000000000000000    79      FUNC    GLOBAL DEFAULT    1 main

```

